<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Domain Redirect Dashboard - Advanced Protection</title>
    <style>
        body {
            background: #0f0f23;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.connected { background: #4caf50; }
        .status.disconnected { background: #f44336; }
        .status.connecting { background: #ff9800; }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            background: #232344;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: #fff;
        }
        .tab:hover:not(.active) {
            background: #2d3255;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #232344;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 14px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #fff;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .length-presets {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .preset-btn {
            background: #2d3255;
            color: #fff;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .preset-btn:hover {
            background: #667eea;
        }
        .length-info {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-success {
            background: #4caf50;
        }
        .btn-warning {
            background: #ff9800;
        }
        .btn-purple {
            background: #9c27b0;
        }
        .btn-cyan {
            background: #00bcd4;
        }
        .redirect-item, .domain-item, .ip-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .domain-item.verified {
            border-left-color: #4caf50;
        }
        .domain-item.pending {
            border-left-color: #ff9800;
        }
        .domain-item.failed {
            border-left-color: #f44336;
        }
        
        /* Enhanced URL display styles */
        .redirect-url-container {
            margin: 10px 0;
            padding: 12px;
            background: #222;
            border-radius: 6px;
            border: 1px solid #555;
        }
        .redirect-url-short {
            color: #4caf50;
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            display: block;
            word-break: break-all;
        }
        .redirect-url-full {
            color: #4caf50;
            font-family: monospace;
            font-size: 12px;
            background: #1a1a1a;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            word-break: break-all;
            border: 1px solid #666;
            display: none;
        }
        .url-toggle {
            color: #667eea;
            font-size: 11px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }
        .url-toggle:hover {
            color: #5a6fd8;
        }
        .url-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .copy-feedback {
            color: #4caf50;
            font-size: 11px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-feedback.show {
            opacity: 1;
        }
        
        .redirect-url {
            color: #4caf50;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        .domain-name {
            color: #4caf50;
            font-family: monospace;
            font-weight: bold;
            font-size: 18px;
        }
        .domain-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .domain-status.verified {
            background: #4caf50;
            color: white;
        }
        .domain-status.pending {
            background: #ff9800;
            color: white;
        }
        .domain-status.failed {
            background: #f44336;
            color: white;
        }
        .dns-instructions {
            background: #2a2a44;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .dns-record {
            margin: 8px 0;
            padding: 8px;
            background: #333;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .verification-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .verification-result.success {
            background: #1e4d2e;
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }
        .verification-result.failed {
            background: #4d1e1e;
            color: #ff6b6b;
            border-left: 4px solid #f44336;
        }
        .redirect-destination {
            color: #ccc;
            margin: 5px 0;
            word-break: break-all;
        }
        .redirect-stats {
            color: #999;
            font-size: 12px;
            margin: 5px 0;
        }
        .domain-stats {
            color: #999;
            font-size: 12px;
            margin: 5px 0;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .error { 
            background: #4d1e1e;
            color: #ff6b6b; 
            border-left: 4px solid #f44336;
        }
        .success { 
            background: #1e4d2e;
            color: #4caf50; 
            border-left: 4px solid #4caf50;
        }
        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #232344;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #ccc;
            font-size: 12px;
            margin-top: 5px;
        }
        .settings-info {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            padding: 8px;
            background: #2a2a44;
            border-radius: 4px;
        }
        
        /* Threat Protection specific styles */
        .ip-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            background: #222;
        }
        .ip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #444;
            font-family: monospace;
            background: #333;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .ip-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .ip-text {
            color: #ff6b6b;
            font-weight: bold;
        }
        .threat-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 10px;
            color: white;
        }
        .threat-status.vpn {
            background: #ff6b6b;
        }
        .threat-status.proxy {
            background: #ff9800;
        }
        .threat-status.crawler {
            background: #9c27b0;
        }
        .clear-all-btn {
            background: #ff9800;
            margin-left: 10px;
        }
        .clear-all-btn:hover {
            background: #f57c00;
        }
        .protection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .protection-card {
            background: #232344;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .protection-card.vpn {
            border-left-color: #ff6b6b;
        }
        .protection-card.proxy {
            border-left-color: #ff9800;
        }
        .protection-card.crawler {
            border-left-color: #9c27b0;
        }
        .protection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .protection-title {
            font-size: 18px;
            font-weight: bold;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.enabled {
            background: #4caf50;
            color: white;
        }
        .status-badge.disabled {
            background: #666;
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                margin: 2px 0;
                border-radius: 4px;
            }
            .form-row {
                flex-direction: column;
            }
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            .length-presets {
                gap: 3px;
            }
            .url-actions {
                flex-direction: column;
            }
            .protection-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Multi-Domain Redirect Dashboard</h1>
            <p>Advanced protection with VPN, Proxy, and Crawler detection</p>
        </div>
        
        <div id="status" class="status connecting">
            üîÑ Connecting to server...
        </div>

        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalRedirects">0</div>
                <div class="stat-label">Total Redirects</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClicks">0</div>
                <div class="stat-label">Total Clicks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDomains">0</div>
                <div class="stat-label">Total Domains</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="verifiedDomains">0</div>
                <div class="stat-label">Verified Domains</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="bannedIPs">0</div>
                <div class="stat-label">Banned IPs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockedVpnIPs">0</div>
                <div class="stat-label">Blocked VPNs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockedProxyIPs">0</div>
                <div class="stat-label">Blocked Proxies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockedCrawlerIPs">0</div>
                <div class="stat-label">Blocked Crawlers</div>
            </div>
        </div>

        <div class="tabs" id="tabsSection" style="display: none;">
            <button class="tab active" onclick="showTab('domains')">üåê Domains</button>
            <button class="tab" onclick="showTab('redirects')">üîó Redirects</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="showTab('protection')">üõ°Ô∏è Threat Protection</button>
        </div>

        <!-- Domains Tab -->
        <div id="domains-tab" class="tab-content active">
            <div class="form-section">
                <h2>üåê Add New Domain</h2>
                
                <div class="form-group">
                    <label for="newDomain">Domain Name:</label>
                    <input type="text" id="newDomain" placeholder="example.com" required>
                    <div class="settings-info">
                        Enter your domain without "www" or "https://" (e.g., "example.com")
                    </div>
                </div>

                <button id="addDomainBtn" onclick="addDomain()" disabled>
                    üåê Add Domain
                </button>

                <div id="domainResult"></div>
            </div>

            <div class="form-section">
                <h2>üìã Your Domains</h2>
                <div id="domainsList" class="loading">Loading domains...</div>
            </div>
        </div>

        <!-- Redirects Tab -->
        <div id="redirects-tab" class="tab-content">
            <div class="form-section">
                <h2>‚ú® Create New Redirect</h2>
                
                <div class="form-group">
                    <label for="destinationUrl">üéØ Destination URL:</label>
                    <input type="url" id="destinationUrl" placeholder="https://example.com/your-page" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="redirectDomain">üåê Domain:</label>
                        <select id="redirectDomain">
                            <option value="">Loading domains...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="customPath">üî§ Custom Path (optional):</label>
                        <input type="text" id="customPath" placeholder="my-custom-link">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prefix">üìÇ Prefix (optional):</label>
                        <select id="prefix">
                            <option value="">No prefix</option>
                            <option value="a">a/</option>
                            <option value="b">b/</option>
                            <option value="c">c/</option>
                            <option value="d">d/</option>
                            <option value="e">e/</option>
                            <option value="f">f/</option>
                            <option value="g">g/</option>
                            <option value="h">h/</option>
                            <option value="i">i/</option>
                            <option value="j">j/</option>
                            <option value="k">k/</option>
                            <option value="l">l/</option>
                            <option value="m">m/</option>
                            <option value="n">n/</option>
                            <option value="o">o/</option>
                            <option value="p">p/</option>
                            <option value="q">q/</option>
                            <option value="r">r/</option>
                            <option value="s">s/</option>
                            <option value="t">t/</option>
                            <option value="u">u/</option>
                            <option value="v">v/</option>
                            <option value="w">w/</option>
                            <option value="x">x/</option>
                            <option value="y">y/</option>
                            <option value="z">z/</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="length">üìè Length (1-5000):</label>
                        <input type="number" id="length" min="1" max="5000" value="8" placeholder="Enter 1-5000">
                        <div class="length-presets">
                            <button type="button" class="preset-btn" onclick="setLength(8)">8</button>
                            <button type="button" class="preset-btn" onclick="setLength(16)">16</button>
                            <button type="button" class="preset-btn" onclick="setLength(32)">32</button>
                            <button type="button" class="preset-btn" onclick="setLength(64)">64</button>
                            <button type="button" class="preset-btn" onclick="setLength(128)">128</button>
                            <button type="button" class="preset-btn" onclick="setLength(256)">256</button>
                            <button type="button" class="preset-btn" onclick="setLength(512)">512</button>
                            <button type="button" class="preset-btn" onclick="setLength(1000)">1K</button>
                            <button type="button" class="preset-btn" onclick="setLength(2500)">2.5K</button>
                            <button type="button" class="preset-btn" onclick="setLength(5000)">5K</button>
                        </div>
                        <div class="length-info">Click presets or type any number (1-5000 characters)</div>
                    </div>
                </div>

                <button id="createBtn" onclick="createRedirect()" disabled>
                    üöÄ Create Redirect
                </button>

                <div id="redirectResult"></div>
            </div>

            <div class="form-section">
                <h2>üìã Your Redirects</h2>
                <div id="redirectsList" class="loading">Loading redirects...</div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="form-section">
                <h2>‚öôÔ∏è Server Settings</h2>
                
                <div class="form-group">
                    <label for="banRedirectUrl">üîÄ Ban Redirect URL:</label>
                    <input type="url" id="banRedirectUrl" placeholder="https://example.com/banned-page" required>
                    <div class="settings-info">
                        When someone tries to access an unauthorized redirect or a banned IP attempts access, 
                        they will be redirected to this URL instead of getting an error page.
                    </div>
                </div>

                <div class="form-group">
                    <div class="toggle-switch">
                        <label>üîÄ Enable Ban Redirects:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableBanRedirect" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="banRedirectStatus">Enabled</span>
                    </div>
                    <div class="settings-info">
                        When enabled, banned/unauthorized requests are redirected to your chosen URL. 
                        When disabled, they get a "Forbidden" error page.
                    </div>
                </div>

                <button id="saveSettingsBtn" onclick="saveSettings()" disabled>
                    üíæ Save Settings
                </button>

                <div id="settingsResult"></div>
            </div>
        </div>

        <!-- Threat Protection Tab -->
        <div id="protection-tab" class="tab-content">
            <div class="protection-grid">
                <!-- VPN Protection Card -->
                <div class="protection-card vpn">
                    <div class="protection-header">
                        <div class="protection-title">üõ°Ô∏è VPN Detection</div>
                        <div class="status-badge" id="vpnStatusBadge">Disabled</div>
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable VPN Detection:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableVpnDetection">
                            <span class="slider"></span>
                        </label>
                        <span id="vpnDetectionStatus">Disabled</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="vpnRedirectUrl">VPN Redirect URL:</label>
                        <input type="url" id="vpnRedirectUrl" placeholder="https://office.com" value="">
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable VPN Redirect:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableVpnRedirect" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="vpnRedirectStatus">Enabled</span>
                    </div>
                    
                    <button onclick="testVpnDetection()" class="btn btn-warning btn-small">üîç Test VPN</button>
                </div>

                <!-- Proxy Protection Card -->
                <div class="protection-card proxy">
                    <div class="protection-header">
                        <div class="protection-title">üï∏Ô∏è Proxy Detection</div>
                        <div class="status-badge" id="proxyStatusBadge">Disabled</div>
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable Proxy Detection:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableProxyDetection">
                            <span class="slider"></span>
                        </label>
                        <span id="proxyDetectionStatus">Disabled</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="proxyRedirectUrl">Proxy Redirect URL:</label>
                        <input type="url" id="proxyRedirectUrl" placeholder="https://office.com" value="">
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable Proxy Redirect:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableProxyRedirect" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="proxyRedirectStatus">Enabled</span>
                    </div>
                    
                    <button onclick="testThreatDetection()" class="btn btn-warning btn-small">üîç Test Proxy</button>
                </div>

                <!-- Crawler Protection Card -->
                <div class="protection-card crawler">
                    <div class="protection-header">
                        <div class="protection-title">ü§ñ Crawler Detection</div>
                        <div class="status-badge" id="crawlerStatusBadge">Disabled</div>
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable Crawler Detection:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableCrawlerDetection">
                            <span class="slider"></span>
                        </label>
                        <span id="crawlerDetectionStatus">Disabled</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="crawlerRedirectUrl">Crawler Redirect URL:</label>
                        <input type="url" id="crawlerRedirectUrl" placeholder="https://office.com" value="">
                    </div>
                    
                    <div class="toggle-switch">
                        <label>Enable Crawler Redirect:</label>
                        <label class="switch">
                            <input type="checkbox" id="enableCrawlerRedirect" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="crawlerRedirectStatus">Enabled</span>
                    </div>
                    
                    <button onclick="testThreatDetection()" class="btn btn-warning btn-small">üîç Test Crawler</button>
                </div>
            </div>

            <div class="form-section">
                <button onclick="updateThreatProtectionSettings()" class="btn">üõ°Ô∏è Update All Protection Settings</button>
                <div id="protectionResult"></div>
            </div>

            <!-- Blocked IPs Management -->
            <div class="form-section">
                <h2>üö´ Blocked IPs Management</h2>
                
                <div class="tabs" style="margin-bottom: 15px;">
                    <button class="tab active" onclick="showBlockedTab('vpn')">üõ°Ô∏è VPN IPs</button>
                    <button class="tab" onclick="showBlockedTab('proxy')">üï∏Ô∏è Proxy IPs</button>
                    <button class="tab" onclick="showBlockedTab('crawler')">ü§ñ Crawler IPs</button>
                </div>

                <!-- VPN Blocked IPs -->
                <div id="vpn-blocked-tab" class="tab-content active">
                    <h3>üõ°Ô∏è Blocked VPN IPs</h3>
                    <button onclick="loadBlockedVpnIPs()" class="btn btn-small">üîÑ Refresh</button>
                    <button onclick="clearAllVpnIPs()" class="btn clear-all-btn btn-small">üóëÔ∏è Clear All</button>
                    <div id="vpnIPsList"></div>
                </div>

                <!-- Proxy Blocked IPs -->
                <div id="proxy-blocked-tab" class="tab-content">
                    <h3>üï∏Ô∏è Blocked Proxy IPs</h3>
                    <button onclick="loadBlockedProxyIPs()" class="btn btn-small">üîÑ Refresh</button>
                    <button onclick="clearAllProxyIPs()" class="btn clear-all-btn btn-small">üóëÔ∏è Clear All</button>
                    <div id="proxyIPsList"></div>
                </div>

                <!-- Crawler Blocked IPs -->
                <div id="crawler-blocked-tab" class="tab-content">
                    <h3>ü§ñ Blocked Crawler IPs</h3>
                    <button onclick="loadBlockedCrawlerIPs()" class="btn btn-small">üîÑ Refresh</button>
                    <button onclick="clearAllCrawlerIPs()" class="btn clear-all-btn btn-small">üóëÔ∏è Clear All</button>
                    <div id="crawlerIPsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANT: Update these settings
        const CONFIG = {
            serverUrl: 'https://maxforums.co',           // Your redirect server
            apiKey: 'mySecretKey123456789'               // CHANGE THIS to match your server!
        };

        let isConnected = false;
        let redirects = [];
        let domains = [];
        let serverSettings = {};
        let serverIP = '';

        window.onload = function() {
            console.log('üöÄ Starting multi-domain dashboard with threat protection...');
            testConnection();
            setupLengthValidation();
            setupSettingsToggle();
            setupThreatProtectionToggles();
        };

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            if (tabName === 'domains' && isConnected) {
                loadDomains();
            } else if (tabName === 'redirects' && isConnected) {
                loadRedirects();
            } else if (tabName === 'settings' && isConnected) {
                loadSettings();
            } else if (tabName === 'protection' && isConnected) {
                loadThreatProtectionSettings();
                loadAllBlockedIPs();
            }
        }

        function showBlockedTab(type) {
            // Hide all blocked IP tabs
            document.querySelectorAll('[id$="-blocked-tab"]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#protection-tab .tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${type}-blocked-tab`).classList.add('active');
            event.target.classList.add('active');

            // Load data for the specific type
            if (type === 'vpn') {
                loadBlockedVpnIPs();
            } else if (type === 'proxy') {
                loadBlockedProxyIPs();
            } else if (type === 'crawler') {
                loadBlockedCrawlerIPs();
            }
        }

        function setupThreatProtectionToggles() {
            // VPN toggles
            const vpnDetectionToggle = document.getElementById('enableVpnDetection');
            const vpnRedirectToggle = document.getElementById('enableVpnRedirect');
            const vpnDetectionStatus = document.getElementById('vpnDetectionStatus');
            const vpnRedirectStatus = document.getElementById('vpnRedirectStatus');
            const vpnStatusBadge = document.getElementById('vpnStatusBadge');
            
            vpnDetectionToggle.addEventListener('change', function() {
                const status = this.checked ? 'Enabled' : 'Disabled';
                vpnDetectionStatus.textContent = status;
                vpnStatusBadge.textContent = status;
                vpnStatusBadge.className = `status-badge ${this.checked ? 'enabled' : 'disabled'}`;
            });
            
            vpnRedirectToggle.addEventListener('change', function() {
                vpnRedirectStatus.textContent = this.checked ? 'Enabled' : 'Disabled';
            });

            // Proxy toggles
            const proxyDetectionToggle = document.getElementById('enableProxyDetection');
            const proxyRedirectToggle = document.getElementById('enableProxyRedirect');
            const proxyDetectionStatus = document.getElementById('proxyDetectionStatus');
            const proxyRedirectStatus = document.getElementById('proxyRedirectStatus');
            const proxyStatusBadge = document.getElementById('proxyStatusBadge');
            
            proxyDetectionToggle.addEventListener('change', function() {
                const status = this.checked ? 'Enabled' : 'Disabled';
                proxyDetectionStatus.textContent = status;
                proxyStatusBadge.textContent = status;
                proxyStatusBadge.className = `status-badge ${this.checked ? 'enabled' : 'disabled'}`;
            });
            
            proxyRedirectToggle.addEventListener('change', function() {
                proxyRedirectStatus.textContent = this.checked ? 'Enabled' : 'Disabled';
            });

            // Crawler toggles
            const crawlerDetectionToggle = document.getElementById('enableCrawlerDetection');
            const crawlerRedirectToggle = document.getElementById('enableCrawlerRedirect');
            const crawlerDetectionStatus = document.getElementById('crawlerDetectionStatus');
            const crawlerRedirectStatus = document.getElementById('crawlerRedirectStatus');
            const crawlerStatusBadge = document.getElementById('crawlerStatusBadge');
            
            crawlerDetectionToggle.addEventListener('change', function() {
                const status = this.checked ? 'Enabled' : 'Disabled';
                crawlerDetectionStatus.textContent = status;
                crawlerStatusBadge.textContent = status;
                crawlerStatusBadge.className = `status-badge ${this.checked ? 'enabled' : 'disabled'}`;
            });
            
            crawlerRedirectToggle.addEventListener('change', function() {
                crawlerRedirectStatus.textContent = this.checked ? 'Enabled' : 'Disabled';
            });
        }

        function setupSettingsToggle() {
            const toggle = document.getElementById('enableBanRedirect');
            const status = document.getElementById('banRedirectStatus');
            
            toggle.addEventListener('change', function() {
                status.textContent = this.checked ? 'Enabled' : 'Disabled';
            });
        }

        function setupLengthValidation() {
            const lengthInput = document.getElementById('length');
            
            lengthInput.addEventListener('input', function() {
                let value = parseInt(this.value);
                
                if (value < 1) {
                    this.value = 1;
                } else if (value > 5000) {
                    this.value = 5000;
                }
                
                const info = document.querySelector('.length-info');
                const currentValue = parseInt(this.value) || 8;
                
                if (currentValue <= 10) {
                    info.textContent = `${currentValue} chars - Very short link`;
                } else if (currentValue <= 50) {
                    info.textContent = `${currentValue} chars - Short link`;
                } else if (currentValue <= 500) {
                    info.textContent = `${currentValue} chars - Medium link`;
                } else if (currentValue <= 2000) {
                    info.textContent = `${currentValue} chars - Long link`;
                } else {
                    info.textContent = `${currentValue} chars - Very long link`;
                }
            });
        }

        function setLength(length) {
            const lengthInput = document.getElementById('length');
            lengthInput.value = length;
            lengthInput.dispatchEvent(new Event('input'));
        }

        // Smart URL truncation function - EXACTLY 80 characters
        function truncateUrl(url) {
            if (url.length <= 80) {
                return url;
            }
            return url.substring(0, 80) + '...';
        }

        // Toggle full URL display
        function toggleFullUrl(uniqueId) {
            const fullUrlDiv = document.getElementById(`full-${uniqueId}`);
            const toggleText = document.getElementById(`toggle-text-${uniqueId}`);
            
            if (fullUrlDiv.style.display === 'none' || fullUrlDiv.style.display === '') {
                fullUrlDiv.style.display = 'block';
                toggleText.textContent = 'Hide full URL';
            } else {
                fullUrlDiv.style.display = 'none';
                toggleText.textContent = 'Show full URL';
            }
        }

        // Enhanced copy function with visual feedback
        function copyToClipboard(text, feedbackId = null) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(feedbackId);
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyFeedback(feedbackId);
            });
        }

        // Show copy feedback
        function showCopyFeedback(feedbackId) {
            if (feedbackId) {
                const feedback = document.getElementById(`copy-feedback-${feedbackId}`);
                if (feedback) {
                    feedback.classList.add('show');
                    setTimeout(() => {
                        feedback.classList.remove('show');
                    }, 2000);
                }
            }
            showRedirectResult('üìã URL copied to clipboard!', 'success');
        }

        // Threat Protection Functions
        async function loadThreatProtectionSettings() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/settings`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    
                    // VPN Settings
                    document.getElementById('enableVpnDetection').checked = settings.enableVpnDetection || false;
                    document.getElementById('vpnRedirectUrl').value = settings.vpnRedirectUrl || 'https://office.com';
                    document.getElementById('enableVpnRedirect').checked = settings.enableVpnRedirect !== false;
                    
                    // Proxy Settings
                    document.getElementById('enableProxyDetection').checked = settings.enableProxyDetection || false;
                    document.getElementById('proxyRedirectUrl').value = settings.proxyRedirectUrl || 'https://office.com';
                    document.getElementById('enableProxyRedirect').checked = settings.enableProxyRedirect !== false;
                    
                    // Crawler Settings
                    document.getElementById('enableCrawlerDetection').checked = settings.enableCrawlerDetection || false;
                    document.getElementById('crawlerRedirectUrl').value = settings.crawlerRedirectUrl || 'https://office.com';
                    document.getElementById('enableCrawlerRedirect').checked = settings.enableCrawlerRedirect !== false;
                    
                    // Update status displays
                    updateStatusDisplays(settings);
                }
            } catch (error) {
                console.error('Error loading threat protection settings:', error);
            }
        }

        function updateStatusDisplays(settings) {
            // VPN Status
            const vpnEnabled = settings.enableVpnDetection || false;
            document.getElementById('vpnDetectionStatus').textContent = vpnEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('vpnRedirectStatus').textContent = settings.enableVpnRedirect !== false ? 'Enabled' : 'Disabled';
            const vpnBadge = document.getElementById('vpnStatusBadge');
            vpnBadge.textContent = vpnEnabled ? 'Enabled' : 'Disabled';
            vpnBadge.className = `status-badge ${vpnEnabled ? 'enabled' : 'disabled'}`;
            
            // Proxy Status
            const proxyEnabled = settings.enableProxyDetection || false;
            document.getElementById('proxyDetectionStatus').textContent = proxyEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('proxyRedirectStatus').textContent = settings.enableProxyRedirect !== false ? 'Enabled' : 'Disabled';
            const proxyBadge = document.getElementById('proxyStatusBadge');
            proxyBadge.textContent = proxyEnabled ? 'Enabled' : 'Disabled';
            proxyBadge.className = `status-badge ${proxyEnabled ? 'enabled' : 'disabled'}`;
            
            // Crawler Status
            const crawlerEnabled = settings.enableCrawlerDetection || false;
            document.getElementById('crawlerDetectionStatus').textContent = crawlerEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('crawlerRedirectStatus').textContent = settings.enableCrawlerRedirect !== false ? 'Enabled' : 'Disabled';
            const crawlerBadge = document.getElementById('crawlerStatusBadge');
            crawlerBadge.textContent = crawlerEnabled ? 'Enabled' : 'Disabled';
            crawlerBadge.className = `status-badge ${crawlerEnabled ? 'enabled' : 'disabled'}`;
        }

        async function updateThreatProtectionSettings() {
            try {
                const settings = {
                    // VPN Settings
                    enableVpnDetection: document.getElementById('enableVpnDetection').checked,
                    vpnRedirectUrl: document.getElementById('vpnRedirectUrl').value,
                    enableVpnRedirect: document.getElementById('enableVpnRedirect').checked,
                    // Proxy Settings
                    enableProxyDetection: document.getElementById('enableProxyDetection').checked,
                    proxyRedirectUrl: document.getElementById('proxyRedirectUrl').value,
                    enableProxyRedirect: document.getElementById('enableProxyRedirect').checked,
                    // Crawler Settings
                    enableCrawlerDetection: document.getElementById('enableCrawlerDetection').checked,
                    crawlerRedirectUrl: document.getElementById('crawlerRedirectUrl').value,
                    enableCrawlerRedirect: document.getElementById('enableCrawlerRedirect').checked
                };

                const response = await fetch(`${CONFIG.serverUrl}/api/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showProtectionResult('üõ°Ô∏è All threat protection settings updated successfully!', 'success');
                    loadStats(); // Refresh stats
                } else {
                    const error = await response.json();
                    showProtectionResult(`‚ùå Error: ${error.error}`, 'error');
                }
            } catch (error) {
                showProtectionResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testVpnDetection() {
            // Get current user's IP for testing
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;
                
                showProtectionResult(`üîç Testing VPN detection for IP: ${userIP}...`, 'success');
                
                const response = await fetch(`${CONFIG.serverUrl}/api/vpn-test/${userIP}`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const status = result.isVPN ? 'üö´ VPN DETECTED' : '‚úÖ Clean IP';
                    showProtectionResult(`${status} - IP: ${result.ip} | VPN: ${result.isVPN}`, result.isVPN ? 'error' : 'success');
                } else {
                    showProtectionResult('‚ùå VPN test failed', 'error');
                }
            } catch (error) {
                showProtectionResult(`‚ùå Test error: ${error.message}`, 'error');
            }
        }

        async function testThreatDetection() {
            // Get current user's IP for testing
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;
                
                showProtectionResult(`üîç Testing threat analysis for IP: ${userIP}...`, 'success');
                
                const response = await fetch(`${CONFIG.serverUrl}/api/threat-test/${userIP}`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const threats = [];
                    if (result.isProxy) threats.push('üï∏Ô∏è PROXY');
                    if (result.isCrawler) threats.push('ü§ñ CRAWLER');
                    
                    const status = threats.length > 0 ? threats.join(' + ') + ' DETECTED' : '‚úÖ Clean IP';
                    showProtectionResult(`${status} - IP: ${result.ip} | Proxy: ${result.isProxy} | Crawler: ${result.isCrawler}`, threats.length > 0 ? 'error' : 'success');
                } else {
                    showProtectionResult('‚ùå Threat analysis test failed', 'error');
                }
            } catch (error) {
                showProtectionResult(`‚ùå Test error: ${error.message}`, 'error');
            }
        }

        // Blocked IPs Management Functions
        function loadAllBlockedIPs() {
            loadBlockedVpnIPs();
            loadBlockedProxyIPs();
            loadBlockedCrawlerIPs();
        }

        async function loadBlockedVpnIPs() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/blocked-vpn-ips`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBlockedIPs('vpn', data.ips, 'VPN');
                }
            } catch (error) {
                console.error('Error loading blocked VPN IPs:', error);
            }
        }

        async function loadBlockedProxyIPs() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/blocked-proxy-ips`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBlockedIPs('proxy', data.ips, 'PROXY');
                }
            } catch (error) {
                console.error('Error loading blocked Proxy IPs:', error);
            }
        }

        async function loadBlockedCrawlerIPs() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/blocked-crawler-ips`, {
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBlockedIPs('crawler', data.ips, 'CRAWLER');
                }
            } catch (error) {
                console.error('Error loading blocked Crawler IPs:', error);
            }
        }

        function displayBlockedIPs(type, ips, label) {
            const listElement = document.getElementById(`${type}IPsList`);
            
            if (ips.length === 0) {
                listElement.innerHTML = `<p style="color: #999; text-align: center; padding: 20px;">üì≠ No ${label} IPs blocked yet.</p>`;
                return;
            }

            listElement.innerHTML = `
                <h4>üö´ Blocked ${label} IPs (${ips.length}):</h4>
                <div class="ip-list">
                    ${ips.map(ip => `
                        <div class="ip-item">
                            <span class="ip-text">${ip}<span class="threat-status ${type}">${label}</span></span>
                            <button onclick="unblock${label}IP('${ip}')" class="btn-small btn-danger">üîì Unblock</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Unblock functions
        async function unblockVPNIP(ip) {
            await unblockIP('vpn', ip, 'VPN');
        }

        async function unblockPROXYIP(ip) {
            await unblockIP('proxy', ip, 'Proxy');
        }

        async function unblockCRAWLERIP(ip) {
            await unblockIP('crawler', ip, 'Crawler');
        }

        async function unblockIP(type, ip, label) {
            if (!confirm(`üîì Are you sure you want to unblock ${label} IP: ${ip}?`)) return;
            
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/blocked-${type}-ips/${encodeURIComponent(ip)}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    showProtectionResult(`‚úÖ ${label} IP ${ip} unblocked successfully!`, 'success');
                    if (type === 'vpn') loadBlockedVpnIPs();
                    else if (type === 'proxy') loadBlockedProxyIPs();
                    else if (type === 'crawler') loadBlockedCrawlerIPs();
                    loadStats();
                } else {
                    const error = await response.json();
                    showProtectionResult(`‚ùå Error: ${error.error}`, 'error');
                }
            } catch (error) {
                showProtectionResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Clear all functions
        async function clearAllVpnIPs() {
            await clearAllIPs('vpn', 'VPN');
        }

        async function clearAllProxyIPs() {
            await clearAllIPs('proxy', 'Proxy');
        }

        async function clearAllCrawlerIPs() {
            await clearAllIPs('crawler', 'Crawler');
        }

        async function clearAllIPs(type, label) {
            if (!confirm(`üóëÔ∏è Are you sure you want to clear ALL blocked ${label} IPs? This cannot be undone.`)) return;
            
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/blocked-${type}-ips`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showProtectionResult(`‚úÖ ${result.message}`, 'success');
                    if (type === 'vpn') loadBlockedVpnIPs();
                    else if (type === 'proxy') loadBlockedProxyIPs();
                    else if (type === 'crawler') loadBlockedCrawlerIPs();
                    loadStats();
                } else {
                    const error = await response.json();
                    showProtectionResult(`‚ùå Error: ${error.error}`, 'error');
                }
            } catch (error) {
                showProtectionResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function showProtectionResult(message, type) {
            const result = document.getElementById('protectionResult');
            result.innerHTML = `<div class="${type}" style="margin-top: 15px; padding: 10px; border-radius: 5px;">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    result.innerHTML = '';
                }, 5000);
            }
        }

        async function testConnection() {
            const statusEl = document.getElementById('status');
            
            try {
                console.log('üîó Testing connection to:', CONFIG.serverUrl);
                
                const response = await fetch(`${CONFIG.serverUrl}/api/health`, {
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                if (response.ok) {
                    const config = await response.json();
                    serverSettings = config.settings || {};
                    serverIP = config.serverIP || 'Unknown';
                    
                    isConnected = true;
                    statusEl.textContent = '‚úÖ Connected to multi-domain server with advanced protection!';
                    statusEl.className = 'status connected';
                    
                    // Enable UI
                    document.getElementById('addDomainBtn').disabled = false;
                    document.getElementById('createBtn').disabled = false;
                    document.getElementById('saveSettingsBtn').disabled = false;
                    document.getElementById('statsSection').style.display = 'grid';
                    document.getElementById('tabsSection').style.display = 'flex';
                    
                    console.log('‚úÖ Connection successful! Server IP:', serverIP);
                    await loadDomains();
                    await loadRedirects();
                    await loadSettings();
                    await loadThreatProtectionSettings();
                    await loadStats();
                } else if (response.status === 401) {
                    throw new Error('‚ùå Invalid API key - please check your configuration');
                } else {
                    throw new Error(`‚ùå Server responded with error: ${response.status}`);
                }
            } catch (error) {
                isConnected = false;
                statusEl.textContent = `‚ùå Connection failed: ${error.message}`;
                statusEl.className = 'status disconnected';
                
                console.error('‚ùå Connection error:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/stats`, {
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                const stats = await response.json();
                document.getElementById('totalRedirects').textContent = stats.totalRedirects || 0;
                document.getElementById('totalClicks').textContent = stats.totalClicks || 0;
                document.getElementById('totalDomains').textContent = stats.totalDomains || 0;
                document.getElementById('verifiedDomains').textContent = stats.verifiedDomains || 0;
                document.getElementById('bannedIPs').textContent = stats.bannedIPs || 0;
                document.getElementById('blockedVpnIPs').textContent = stats.blockedVpnIPs || 0;
                document.getElementById('blockedProxyIPs').textContent = stats.blockedProxyIPs || 0;
                document.getElementById('blockedCrawlerIPs').textContent = stats.blockedCrawlerIPs || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadDomains() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/domains`, {
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                domains = await response.json();
                displayDomains();
                updateDomainDropdown();
            } catch (error) {
                document.getElementById('domainsList').innerHTML = 
                    `<div class="error">Failed to load domains: ${error.message}</div>`;
            }
        }

        function displayDomains() {
            const list = document.getElementById('domainsList');
            
            if (domains.length === 0) {
                list.innerHTML = '<div class="loading">üì≠ No domains yet. Add your first domain above!</div>';
                return;
            }

            list.innerHTML = domains.map(domain => {
                const addedDate = new Date(domain.added).toLocaleDateString();
                const verifiedDate = domain.verified ? new Date(domain.verified).toLocaleDateString() : 'Not verified';
                
                return `
                    <div class="domain-item ${domain.status}">
                        <div class="domain-name">
                            ${domain.domain}
                            <span class="domain-status ${domain.status}">${domain.status.toUpperCase()}</span>
                            ${domain.isDefault ? '<span class="domain-status verified">DEFAULT</span>' : ''}
                        </div>
                        <div class="domain-stats">
                            üîó ${domain.redirectCount || 0} redirects | üìÖ Added: ${addedDate} | 
                            ‚úÖ Verified: ${verifiedDate}
                        </div>
                        ${domain.status === 'pending' ? getDNSInstructions(domain.domain) : ''}
                        ${domain.status === 'failed' ? getFailedInstructions(domain.domain) : ''}
                        <div style="margin-top: 10px;">
                            ${domain.status === 'pending' || domain.status === 'failed' ? 
                                `<button onclick="verifyDomain('${domain.domain}')" class="btn-warning btn-small">üîç Verify DNS</button>` : 
                                `<button onclick="testDomain('${domain.domain}')" class="btn-success btn-small">üîó Test Domain</button>`
                            }
                            ${!domain.isDefault ? 
                                `<button onclick="deleteDomain('${domain.domain}')" class="btn-danger btn-small">üóëÔ∏è Delete</button>` : ''
                            }
                        </div>
                        <div id="verifyResult-${domain.domain.replace('.', '-')}"></div>
                    </div>
                `;
            }).join('');
        }

        function getDNSInstructions(domain) {
            return `
                <div class="dns-instructions">
                    <strong>üìã DNS Setup Instructions:</strong>
                    <div class="dns-record">
                        <strong>A Record:</strong><br>
                        Name: <code>@</code> or <code>${domain}</code><br>
                        Value: <code>${serverIP}</code><br>
                        TTL: <code>300</code> (or default)
                    </div>
                    <div class="dns-record">
                        <strong>CNAME Record (optional but recommended):</strong><br>
                        Name: <code>www</code><br>
                        Value: <code>${domain}</code><br>
                        TTL: <code>300</code> (or default)
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                        üí° Add these records in your domain registrar's DNS settings (GoDaddy, Namecheap, Cloudflare, etc.)
                        <br><strong>‚ö†Ô∏è IMPORTANT:</strong> If using Cloudflare, turn OFF proxy (orange cloud ‚Üí gray cloud) before verification!
                    </div>
                </div>
            `;
        }

        function getFailedInstructions(domain) {
            return `
                <div class="dns-instructions">
                    <strong>‚ùå DNS Verification Failed</strong>
                    <div style="margin: 10px 0; color: #ff6b6b;">
                        Your domain is not pointing to our server yet. Please check:
                    </div>
                    <div class="dns-record">
                        <strong>Required A Record:</strong><br>
                        Name: <code>${domain}</code><br>
                        Should point to: <code>${serverIP}</code>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                        üí° DNS changes can take up to 24 hours to propagate. Wait a bit and try verification again.
                        <br><strong>‚ö†Ô∏è If using Cloudflare:</strong> Make sure proxy is OFF (gray cloud, not orange)
                    </div>
                </div>
            `;
        }

        function updateDomainDropdown() {
            const select = document.getElementById('redirectDomain');
            const verifiedDomains = domains.filter(d => d.status === 'verified');
            
            if (verifiedDomains.length === 0) {
                select.innerHTML = '<option value="">No verified domains available</option>';
                return;
            }
            
            select.innerHTML = verifiedDomains.map(domain => 
                `<option value="${domain.domain}" ${domain.isDefault ? 'selected' : ''}>${domain.domain}${domain.isDefault ? ' (default)' : ''}</option>`
            ).join('');
        }

        async function addDomain() {
            if (!isConnected) {
                alert('‚ùå Not connected to server');
                return;
            }

            const domain = document.getElementById('newDomain').value.trim().toLowerCase();

            if (!domain) {
                showDomainResult('‚ùå Please enter a domain name', 'error');
                return;
            }

            // Basic domain validation
            const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.([a-zA-Z]{2,}\.?)+$/;
            if (!domainRegex.test(domain)) {
                showDomainResult('‚ùå Please enter a valid domain (e.g., example.com)', 'error');
                return;
            }

            const addBtn = document.getElementById('addDomainBtn');
            addBtn.disabled = true;
            addBtn.textContent = '‚è≥ Adding...';

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/domains`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey
                    },
                    body: JSON.stringify({ domain: domain })
                });

                const data = await response.json();

                if (response.ok) {
                    showDomainResult(`
                        <strong>üéâ Domain Added!</strong><br>
                        Domain: ${domain}<br>
                        Status: Pending DNS verification<br><br>
                        <strong>Next Steps:</strong><br>
                        1. Add the DNS records shown below<br>
                        2. If using Cloudflare, turn OFF proxy (orange ‚Üí gray cloud)<br>
                        3. Wait 5-10 minutes for DNS propagation<br>
                        4. Click "Verify DNS" button<br>
                        5. After verification, turn Cloudflare proxy back ON
                    `, 'success');
                    
                    document.getElementById('newDomain').value = '';
                    await loadDomains();
                    await loadStats();
                } else {
                    throw new Error(data.error || 'Failed to add domain');
                }
            } catch (error) {
                showDomainResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'üåê Add Domain';
            }
        }

        async function verifyDomain(domain) {
            const resultId = `verifyResult-${domain.replace('.', '-')}`;
            const resultEl = document.getElementById(resultId);
            
            resultEl.innerHTML = '<div class="loading">üîç Verifying DNS configuration...</div>';

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/domains/${encodeURIComponent(domain)}/verify`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                const data = await response.json();

                if (data.verified) {
                    resultEl.innerHTML = `
                        <div class="verification-result success">
                            <strong>‚úÖ Domain Verified Successfully!</strong><br>
                            A Record: ${data.verification.aRecord}<br>
                            CNAME Record: ${data.verification.cname}<br>
                            Domain is now ready for redirects!<br><br>
                            <strong>‚ú® You can now turn Cloudflare proxy back ON if desired!</strong>
                        </div>
                    `;
                    
                    await loadDomains();
                    await loadStats();
                } else {
                    const verification = data.verification || {};
                    const errors = verification.details?.errors || [];
                    const cloudflareDetected = verification.details?.cloudflareDetected;
                    
                    let errorMessage = `
                        <div class="verification-result failed">
                            <strong>‚ùå DNS Verification Failed</strong><br>
                            A Record: ${verification.aRecord || '‚ùå Failed'}<br>
                            CNAME Record: ${verification.cname || '‚ö†Ô∏è Optional'}<br><br>
                    `;
                    
                    if (cloudflareDetected) {
                        errorMessage += `
                            <strong>üü† Cloudflare Proxy Detected!</strong><br>
                            Please turn OFF the orange cloud (proxy) in Cloudflare DNS settings.<br>
                            Change from "Proxied" to "DNS only" (gray cloud).<br><br>
                        `;
                    }
                    
                    if (errors.length > 0) {
                        errorMessage += `<strong>Issues found:</strong><br>`;
                        errors.forEach(error => {
                            errorMessage += `‚Ä¢ ${error}<br>`;
                        });
                        errorMessage += `<br>`;
                    }
                    
                    errorMessage += `
                            Please check your DNS settings and try again in a few minutes.
                        </div>
                    `;
                    
                    resultEl.innerHTML = errorMessage;
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="verification-result failed">
                        <strong>‚ùå Verification Error</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function testDomain(domain) {
            window.open(`https://${domain}`, '_blank');
        }

        async function deleteDomain(domain) {
            if (!confirm(`üóëÔ∏è Are you sure you want to delete ${domain}?\n\nThis will also delete all redirects on this domain!`)) {
                return;
            }

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/domains/${encodeURIComponent(domain)}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showDomainResult(`‚úÖ Domain ${domain} deleted successfully!`, 'success');
                    await loadDomains();
                    await loadStats();
                } else {
                    throw new Error(data.error || 'Failed to delete domain');
                }
            } catch (error) {
                showDomainResult(`‚ùå Error deleting domain: ${error.message}`, 'error');
            }
        }

        async function loadRedirects() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/redirects`, {
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                redirects = await response.json();
                displayRedirects();
            } catch (error) {
                document.getElementById('redirectsList').innerHTML = 
                    `<div class="error">Failed to load redirects: ${error.message}</div>`;
            }
        }

        // Enhanced display for redirects with 80-character URL truncation
        function displayRedirects() {
            const list = document.getElementById('redirectsList');
            
            if (redirects.length === 0) {
                list.innerHTML = '<div class="loading">üì≠ No redirects yet. Create your first one above!</div>';
                return;
            }

            const sortedRedirects = [...redirects].sort((a, b) => 
                new Date(b.created) - new Date(a.created)
            );

            list.innerHTML = sortedRedirects.map((redirect, index) => {
                const shortUrl = `https://${redirect.domain}/${redirect.fullPath}`;
                const truncatedUrl = truncateUrl(shortUrl); // EXACTLY 80 chars + "..."
                const isLongUrl = shortUrl.length > 80;
                const createdDate = new Date(redirect.created).toLocaleDateString();
                const uniqueId = `redirect-${index}`;
                
                return `
                    <div class="redirect-item">
                        <div class="redirect-url-container">
                            <div class="redirect-url-short" onclick="copyToClipboard('${shortUrl}', '${uniqueId}')" title="Click to copy">
                                üîó ${truncatedUrl}
                            </div>
                            ${isLongUrl ? `
                                <div class="redirect-url-full" id="full-${uniqueId}">
                                    ${shortUrl}
                                </div>
                                <div class="url-toggle" onclick="toggleFullUrl('${uniqueId}')">
                                    <span id="toggle-text-${uniqueId}">Show full URL</span>
                                </div>
                            ` : ''}
                            <span class="copy-feedback" id="copy-feedback-${uniqueId}">üìã Copied!</span>
                            
                            <div class="url-actions">
                                <button onclick="copyToClipboard('${shortUrl}', '${uniqueId}')" class="btn-success btn-small">üìã Copy Link</button>
                                <button onclick="window.open('${shortUrl}', '_blank')" class="btn-small">üîó Test</button>
                            </div>
                        </div>
                        
                        <div class="redirect-destination">‚û°Ô∏è ${redirect.destinationUrl}</div>
                        <div class="redirect-stats">
                            üëÜ ${redirect.clicks} clicks | üåê ${redirect.domain} | üìÖ Created: ${createdDate} | 
                            üìè ${redirect.length || 8} chars | 
                            ${redirect.active ? '‚úÖ Active' : '‚ùå Inactive'}
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="toggleRedirect('${redirect.fullPath}', ${redirect.active})" class="btn-small">
                                ${redirect.active ? '‚è∏Ô∏è Deactivate' : '‚ñ∂Ô∏è Activate'}
                            </button>
                            <button onclick="deleteRedirect('${redirect.fullPath}')" class="btn-danger btn-small">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function createRedirect() {
            if (!isConnected) {
                alert('‚ùå Not connected to server');
                return;
            }

            const destinationUrl = document.getElementById('destinationUrl').value.trim();
            const customPath = document.getElementById('customPath').value.trim();
            const prefix = document.getElementById('prefix').value;
            const length = parseInt(document.getElementById('length').value) || 8;
            const domain = document.getElementById('redirectDomain').value;

            if (!destinationUrl) {
                showRedirectResult('‚ùå Please enter a destination URL', 'error');
                return;
            }

            if (!domain) {
                showRedirectResult('‚ùå Please select a verified domain', 'error');
                return;
            }

            if (length < 1 || length > 5000) {
                showRedirectResult('‚ùå Length must be between 1 and 5000 characters', 'error');
                return;
            }

            try {
                new URL(destinationUrl);
            } catch {
                showRedirectResult('‚ùå Please enter a valid URL (include https://)', 'error');
                return;
            }

            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = '‚è≥ Creating...';

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/redirects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        destinationUrl: destinationUrl,
                        customPath: customPath || undefined,
                        prefix: prefix || undefined,
                        length: length,
                        domain: domain
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const shortUrl = `https://${data.domain}/${data.fullPath}`;
                    
                    showRedirectResult(`
                        <strong>üéâ Success!</strong><br>
                        <div style="margin: 10px 0;">
                            <strong>Your short link (${data.length} characters):</strong><br>
                            <div class="redirect-url" onclick="copyToClipboard('${shortUrl}')" title="Click to copy">${truncateUrl(shortUrl)}</div>
                        </div>
                        <button onclick="copyToClipboard('${shortUrl}')" class="btn-success btn-small">üìã Copy Link</button>
                        <button onclick="window.open('${shortUrl}', '_blank')" class="btn-small">üîó Test Link</button>
                    `, 'success');
                    
                    // Clear form
                    document.getElementById('destinationUrl').value = '';
                    document.getElementById('customPath').value = '';
                    document.getElementById('prefix').value = '';
                    document.getElementById('length').value = 8;
                    
                    await loadRedirects();
                    await loadStats();
                    await loadDomains(); // Update redirect counts
                } else {
                    throw new Error(data.error || 'Failed to create redirect');
                }
            } catch (error) {
                showRedirectResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'üöÄ Create Redirect';
            }
        }

        async function deleteRedirect(fullPath) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this redirect?')) return;

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/redirects/${encodeURIComponent(fullPath)}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                if (response.ok) {
                    showRedirectResult('‚úÖ Redirect deleted successfully!', 'success');
                    await loadRedirects();
                    await loadStats();
                    await loadDomains();
                } else {
                    throw new Error('Failed to delete redirect');
                }
            } catch (error) {
                showRedirectResult(`‚ùå Error deleting redirect: ${error.message}`, 'error');
            }
        }

        async function toggleRedirect(fullPath, currentState) {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/redirects/${encodeURIComponent(fullPath)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        active: !currentState
                    })
                });

                if (response.ok) {
                    const action = !currentState ? 'activated' : 'deactivated';
                    showRedirectResult(`‚úÖ Redirect ${action} successfully!`, 'success');
                    await loadRedirects();
                    await loadStats();
                } else {
                    throw new Error('Failed to update redirect');
                }
            } catch (error) {
                showRedirectResult(`‚ùå Error updating redirect: ${error.message}`, 'error');
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/settings`, {
                    headers: {
                        'X-API-Key': CONFIG.apiKey
                    }
                });

                serverSettings = await response.json();
                
                document.getElementById('banRedirectUrl').value = serverSettings.banRedirectUrl || '';
                document.getElementById('enableBanRedirect').checked = serverSettings.enableBanRedirect !== false;
                document.getElementById('banRedirectStatus').textContent = 
                    serverSettings.enableBanRedirect !== false ? 'Enabled' : 'Disabled';
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function saveSettings() {
            if (!isConnected) {
                alert('‚ùå Not connected to server');
                return;
            }

            const banRedirectUrl = document.getElementById('banRedirectUrl').value.trim();
            const enableBanRedirect = document.getElementById('enableBanRedirect').checked;

            if (!banRedirectUrl) {
                showSettingsResult('‚ùå Please enter a ban redirect URL', 'error');
                return;
            }

            try {
                new URL(banRedirectUrl);
            } catch {
                showSettingsResult('‚ùå Please enter a valid URL (include https://)', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveSettingsBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Saving...';

            try {
                const response = await fetch(`${CONFIG.serverUrl}/api/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        banRedirectUrl: banRedirectUrl,
                        enableBanRedirect: enableBanRedirect
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    serverSettings = data;
                    showSettingsResult(`
                        <strong>üíæ Settings Saved!</strong><br>
                        Ban Redirect URL: ${banRedirectUrl}<br>
                        Redirect Enabled: ${enableBanRedirect ? 'Yes' : 'No'}
                    `, 'success');
                } else {
                    throw new Error(data.error || 'Failed to save settings');
                }
            } catch (error) {
                showSettingsResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Settings';
            }
        }

        function showDomainResult(message, type) {
            const result = document.getElementById('domainResult');
            result.innerHTML = `<div class="${type}" style="margin-top: 15px; padding: 10px; border-radius: 5px;">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    result.innerHTML = '';
                }, 5000);
            }
        }

        function showRedirectResult(message, type) {
            const result = document.getElementById('redirectResult');
            result.innerHTML = `<div class="${type}" style="margin-top: 15px; padding: 10px; border-radius: 5px;">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    result.innerHTML = '';
                }, 3000);
            }
        }

        function showSettingsResult(message, type) {
            const result = document.getElementById('settingsResult');
            result.innerHTML = `<div class="${type}" style="margin-top: 15px; padding: 10px; border-radius: 5px;">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    result.innerHTML = '';
                }, 3000);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (isConnected) {
                loadThreatProtectionSettings();
                loadAllBlockedIPs();
            }
        });
    </script>
</body>
</html>
